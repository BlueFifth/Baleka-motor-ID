clear;
clc;
% Initial guesses 
hold off %[output:1ef8beac]





% Big array for portability
% QstepSize
% wStart
% wStepSize
% Kp
% Kd
% Test number:  1  2  3  4  5  6  7  8  9 10 11  12  13  14  15    
Tests = [       3, 5, 1,-1,-4,-1, 6, 3,-2, 2, 0,  0,  0,  0,  0;
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,  1,  5, -5, -2;
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0,30,-20, 20, 15,-30;
                1, 1, 1, 5, 5, 5, 5, 2, 2, 3, 0,  0,  0,  0,  0;
                0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1,  1,  1,  1,  2];
%%
[J, b, Bt, Ct] = AK10lsqPos %[output:18865ac5] %[output:13716439] %[output:5d79b710] %[output:7fe7d649]
%%
function [J, b, Bt, Ct] = AK10lsqPos

%% LSQ for inertia (J), damping (b) , Breakaway torque (Bt), and coloumb friction torque (Ct)


% Data trimming for lsq:
TestsData1 = load("Data/StepTestsRound1V1.mat");
TestsData2 = load("Data/StepTestsRound2V1.mat");

% Lets use 1:7 for steps, 11:14 for validation
% Which motor? 
% Start with front left
MotorNum = 8; % Front left
% Position tests start at 5s
% End varies on tests. For solver time reasons cal it at 10.5 (a bit longer
% than longest test) - might need to adjust
SimTimePos = 5.5;
stepsq = [];
for i = 1:7
    temp = timeseries2timetable(TestsData1.data{i}{MotorNum}.Values.q);
    temp = stepsq{i}.q(5001:5001 + SimTimePos*1000);
    stepsq = stepsq9
    stepsq{i+7} = timeseries2timetable(TestsData2.data{i}{MotorNum}.Values.q);
    stepsq{i+7} = stepsq{i+7}.q(5001:5001 + SimTimePos*1000);
end

mdl = 'AK109_LSQ';
open_system(mdl) %Load the model
in = Simulink.SimulationInput(mdl); % Create simulation input object
in = in.setModelParameter("StopTime",num2str(SimTimePos));
in = in.setVariable('StepTime', 0, 'Workspace',mdl);

% Starting guess:
J = 0.1;
b = 0.1;
Bt = 0.5; % Breakaway friction torque
Ct = 0.2; % Coulomb torque


pid0 = [J, b, Bt, Ct];

options = optimoptions(@lsqnonlin,'Algorithm','levenberg-marquardt',...
   'Display','iter-detailed');
% Optimize the gains
% set_param(mdl,'FastRestart','off');           % Fast restart
% Make Ct < Bt
% Ct -Bt <0
% A = [-1 1];
% % A = [0 0 -1 1];
% b = 0;
% Aeq = [];
% Beq = [];
% pid = lsqnonlin(@tracklsq,pid0,[0.1, 0.1, 0.00001, 0.00001, .000001, .000001],[50, 50, 50, 10000, 50, 50],A, b, Aeq, Beq, @nlcon, options);
% pid = lsqnonlin(@tracklsq,pid0,[0.01, 0.001],[1, 0.5],A, b, Aeq, Beq, @nlcon, options);
pid = lsqnonlin(@tracklsq,pid0,[1.0, 0.5, 0.01],[1.7, 1, 0.5], options);
set_param(mdl,'FastRestart','off');
% Return the gains
J = pid(1); b = pid(2); Bt = pid(3); Ct = pid(4);
    function F = tracklsq(pid)
      persistent startplot
       if isempty(startplot)
          figure
          plot(stepsq, 'r', 'DisplayName', 'Reference Step')
          legend(AutoUpdate="off")
          title("Attempts at solving")
          hold on
          startplot = true;
      end
      % Track the output of optsim to a signal of 1
      % Set the simulation input object parameters
      % in = in.setVariable('Ip',pid(1),'Workspace',mdl);
      % in = in.setVariable('Ii',pid(2),'Workspace',mdl);
      in = in.setVariable('J',pid(1),'Workspace',mdl);
      in = in.setVariable('b', pid(2), 'Workspace', mdl);
      in = in.setVariable('Bt',pid(3),'Workspace',mdl);
      in = in.setVariable('Ct', pid(4), 'Workspace', mdl);
% Big array for portability
% QstepSize
% wStart
% wStepSize
% Kp
% Kd
% Test number:  1  2  3  4  5  6  7  8  9 10 11  12  13  14  15    
Tests = [       3, 5, 1,-1,-4,-1, 6, 3,-2, 2, 0,  0,  0,  0,  0;
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,  1,  5, -5, -2;
                0, 0, 0, 0, 0, 0, 0, 0, 0, 0,30,-20, 20, 15,-30;
                1, 1, 1, 5, 5, 5, 5, 2, 2, 3, 0,  0,  0,  0,  0;
                0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1,  1,  1,  1,  2];
      simdata = cell(1, 14);
      for i=1:7
          in = in.setVariable('qStepSize', Tests(1,i), 'Workspace', mdl);
          in = in.setVariable('wStart', Tests(2,i), 'Workspace', mdl);
          in = in.setVariable('wStepSize', Tests(3,i), 'Workspace', mdl);
          in = in.setVariable('Kp', Tests(4,i), 'Workspace', mdl);
          in = in.setVariable('Kd', Tests(5,i), 'Workspace', mdl);
          out = sim(in);
          simdata(i) = out.yout{1}.Values.Data;
          simdata(i+7)= out.yout{1}.Values.Data;
      end

      F = simdata - stepsq;
      plot(simdata, ':')
    end

    function [c, ceq] = nlcon(x)
        ceq = [];
        c = [];
    end
end


function [Ct] = AK10lsqVel

SimTime = 1.5;
% Get comparison data
data = cell(1,9);
load("VelocitySteps.mat");
steps = cell(1, 9);
for i=1:9
    steps{i} = timeseries2timetable(data{i}{4}.Values);
    steps{i} = steps{i}.M1_vel(4501:4501 + SimTime*1000);
end
stepq = [steps{3}; steps{4};steps{5};steps{6}; steps{9}];

mdl = 'AK109_LSQ';
open_system(mdl) %Load the model
in = Simulink.SimulationInput(mdl); % Create simulation input object
in = in.setModelParameter("StopTime",num2str(SimTime));
in = in.setVariable('StepTime', 0.5, 'Workspace',mdl);
in = in.setVariable('q', 0, 'Workspace', mdl);
in = in.setVariable('Kp', 0, 'Workspace', mdl);


J = 1.59;
b = 1.49;
Bt = 0.7; % Breakaway friction torque
Ct = 0.144; % Coulomb torque
pid0 = [Ct];

options = optimoptions(@lsqnonlin,'Algorithm','levenberg-marquardt',...
   'Display','iter-detailed');
% Optimize the gains
% set_param(mdl,'FastRestart','off');           % Fast restart
% Make Ct < Bt
% Ct -Bt <0
% A = [0 0 0 0 -1 1];
% A = [0 0 -1 1];
% b = 0;
% Aeq = [];
% Beq = [];
% pid = lsqnonlin(@tracklsq,pid0,[0.1, 0.1, 0.00001, 0.00001, .000001, .000001],[50, 50, 50, 10000, 50, 50],A, b, Aeq, Beq, @nlcon, options);
% pid = lsqnonlin(@tracklsq,pid0,[0.00001, 0.00001, .000001, .000001],[50, 10000, 5, 5],A, b, Aeq, Beq, @nlcon, options);
pid = lsqnonlin(@tracklsq,pid0,[0.001],[0.7], options);
set_param(mdl,'FastRestart','off');
% Return the gains
% J = pid(1); b = pid(2); Bt = pid(3); Ct = pid(4);
Ct = pid(1);
    function F = tracklsq(pid)
      persistent startplot
       if isempty(startplot)
          figure
          plot(stepq, 'r', 'DisplayName', 'Reference Step')
          legend(AutoUpdate="off")
          title("Attempts at solving")
          hold on
          startplot = true;
      end
      % Track the output of optsim to a signal of 1
      % Set the simulation input object parameters
      in = in.setVariable('Ct', pid(1), 'Workspace', mdl);

      
      % Step 1
      in = in.setVariable('StartVel', 1, 'Workspace', mdl);
      in = in.setVariable('StepVel', 30, 'Workspace', mdl);
      in = in.setVariable('Kd', 1, 'Workspace', mdl);
      out = sim(in);
      simdata = out.yout{1}.Values.Data;
      
      % Step 2
      in = in.setVariable('StartVel', 1, 'Workspace', mdl);
      in = in.setVariable('StepVel', -20, 'Workspace', mdl);
      in = in.setVariable('Kd', 1, 'Workspace', mdl);
      out = sim(in);
      simdata = [simdata; out.yout{1}.Values.Data];

      % Step 3
      in = in.setVariable('StartVel', 5, 'Workspace', mdl);
      in = in.setVariable('StepVel', 20, 'Workspace', mdl);
      in = in.setVariable('Kd', 1, 'Workspace', mdl);
      out = sim(in);
      simdata = [simdata; out.yout{1}.Values.Data];

      % Step 4
      in = in.setVariable('StartVel', -5, 'Workspace', mdl);
      in = in.setVariable('StepVel', 15, 'Workspace', mdl);
      in = in.setVariable('Kd', 1, 'Workspace', mdl);
      out = sim(in);
      simdata = [simdata; out.yout{1}.Values.Data];

      % Step 5
      in = in.setVariable('StartVel', -2, 'Workspace', mdl);
      in = in.setVariable('StepVel', -30, 'Workspace', mdl);
      in = in.setVariable('Kd', 5, 'Workspace', mdl);
      out = sim(in);
      simdata = [simdata; out.yout{1}.Values.Data];

      F = simdata - stepq;
      plot(simdata, ':')
    end

    function [c, ceq] = nlcon(x)
        ceq = [];
        c = [];
    end
end

%[appendix]{"version":"1.0"}
%---
%[metadata:view]
%   data: {"layout":"onright","rightPanelPercent":28.2}
%---
%[output:1ef8beac]
%   data: {"dataType":"image","outputData":{"dataUri":"data:image\/png;base64,iVBORw0KGgoAAAANSUhEUgAAARYAAACnCAYAAADUrHMrAAAAAXNSR0IArs4c6QAADGRJREFUeF7tnTFIXE0XhudrJIVpvkLUFImF2EeSQBpTpxBsBG20MSBiJyIiFhLEwk4sjAlok0ICQgipXTsLTR0s7KKYlKnS\/D\/nwiw3q+uO386dOR6fBUnUde57nnd8d+7c9Z5\/\/v333\/85HhCAAAQiEviHYIlIk6EgAIGCAMHCRIAABKITIFiiI2VACECAYGEOQAAC0QkQLNGRMiAEIECwMAcgAIHoBAiW6EgZEAIQSB4sL168cMvLy253d9ft7e3hAAQgYJBA0mAZHR11MzMzBcbNzU2CxeCEoiQICIFkwSIrlenpaXd4eOjGxsbc9vY2wcIchIBRAsmCxfOTVcvU1NS1wdLT0+PkQx7n5+fFBw8IQODuEVATLBIoS0tL7unTpwXF9+\/fuw8fPtw9oiiGAATSnQq1WrFIoMi+y9u3b+urFVYszFAI3E0CalYsPlhkc\/fk5ORu0kQ1BCBQECBYmAgQgEB0AsmDpVkFrFiie8uAEMhGgGDJhp4DQ8AuAYLFrrdUBoFsBAiWbOg5MATsEiBY7HpLZRDIRoBgyYaeA0PALgGCxa63VAaBbAQIlmzoOTAE7BIgWOx6S2UQyEaAYMmGngNDwC4BgsWut1QGgWwECJZs6DkwBOwSIFjsektlEMhGgGDJhp4DQ8AuAYLFrrdUBoFsBAiWbOg5MATsEiBY7HpLZRDIRoBgyYaeA0PALgGCxa63VAaBbASiBIs0I5O763d2drofP364ubk5d3Z2dqWonZ0dNzAwUHy9Vqu5hYWF+nO4NWW2OcCBIRCdQJRgkcC4uLhwW1tbbn193R0cHLiNjY2\/xM7Ozrrh4eGid9Djx4+vNC0jWKJ7y4AQyEag7WDxq5XPnz8XYbK2tua6u7vd5OTkX0VJB8SJiQm3srJSBIv\/\/9HRUfE8giXbHODAEIhOIEqwLC8vu93d3aIXswRLf3\/\/tadDvin8r1+\/rnzfB4t0QPz27RstVqNbzYAQSEcgWbCUA+fZs2dNT4V86bRYTTcJOBIEYhOIEiyycdvqVMjvw8iGbV9fX7EXc3p6Wt\/ApcVqbGsZDwL5CLQdLCI9ZPO2vGLp6uoqriL5MGKPJd8E4MgQqIJAlGApX27+\/v17feNWwkQe\/rIyl5ursJAxIaCPQJRgiVEWV4ViUGQMCOggQLDo8AEVEDBFgGAxZSfFQEAHAYJFhw+ogIApAgSLKTspBgI6CBAsOnxABQRMESBYTNlJMRDQQYBg0eEDKiBgigDBYspOioGADgIEiw4fUAEBUwQIFlN2UgwEdBAgWHT4gAoImCJAsJiyk2IgoIMAwaLDB1RAwBQBgsWUnRQDAR0ECBYdPqACAqYIECym7KQYCOggQLDo8AEVEDBFgGAxZSfFQEAHgSjBEtpiVbohjo+PF5WX740rn3NrSh0TAhUQiEEgSrCE3KW\/3Anx8vLSra6uuv39\/aLJGcESw0rGgIAeAm0HS2iL1cY79jciYMWiZ1KgBALtEogSLCEtViVYpGdzb2+v6+jo4FSoXef4eQgoJpAsWOR06eHDh0XP5psaltG7WfFsQRoEAglECZaQFquyYunu7i6amd3UYtXrpndzoIM8DQIKCbQdLFLTbTdv5WeatViVr5+fn9c\/FDJDEgQg0IJAlGAJbbEqq5ahoaFCUq1Wq7de5aoQ8xQCtghECZYYSLgqFIMiY0BABwGCRYcPqICAKQIEiyk7KQYCOggQLDp8QAUETBEgWEzZSTEQ0EGAYNHhAyogYIoAwWLKToqBgA4CBIsOH1ABAVMECBZTdlIMBHQQIFh0+IAKCJgiQLCYspNiIKCDAMGiwwdUQMAUAYLFlJ0UAwEdBAgWHT6gAgKmCBAspuykGAjoIECw6PABFRAwRYBgMWUnxUBABwGCRYcPqICAKQIEiyk7KQYCOghECZbQFqu+ZLn5tjzkjv3+wa0pdUwIVEAgBoEowRJyl34v1vdvpndzDPsYAwI6CbQdLKEtVqV8ee78\/Lz7+fOne\/DgASsWnXMCVRBom0CUYAlpsSpKZWVzfHzsHj16VG9exqlQ2x4yAATUEUgWLHIKNDg4WKxSyl0RG4OFFqvq5giCIHBrAlGCJaTFqqxWBgYG\/hJY3mfxm7f+CbRYvbWX\/AAE1BBoO1j8Kc7FxYXb2tpy6+vr7uDgwG1sbDQt8qYVCy1W1cwNhEDgPxOIEiyhLVa9ypuCZWZmxp2cnPzngvhBCEAgP4EowRKjDN7HEoMiY0BABwGCRYcPqICAKQIEiyk7KQYCOggQLDp8QAUETBEgWEzZSTEQ0EGAYNHhAyogYIoAwWLKToqBgA4CBIsOH1ABAVMECBZTdlIMBHQQIFh0+IAKCJgiQLCYspNiIKCDAMGiwwdUQMAUAYLFlJ0UAwEdBAgWHT6gAgKmCBAspuykGAjoIECw6PABFRAwRYBgMWUnxUBABwGCRYcPqICAKQIEiyk7KQYCOghECZaQFqvl50jptVrNLSws1Clwa0odEwIVEIhBIEqwhLRY9c+RMBkdHXVy0+xPnz7V7+ZPsMSwkzEgoINA28FymxarvuS+vr4rbUIIFh0TAhUQiEEgSrCEtlj1gmXFMjEx4VZWVtzR0VHxZYIlhp2MAQEdBJIHi6xwykHkMfhgocWqjomBCgi0QyBKsIS0WBWR161UGoPFf06L1XZs5WchkJdA28Ei8kM2byVURkZG3OLiojs7O7tStV+x0GI174Tg6BCIQSBKsLRqsep7Ovf29v6l+ePHj1wViuEiY0BAGYEowRKjJjZvY1BkDAjoIECw6PABFRAwRYBgMWUnxUBABwGCRYcPqICAKQIEiyk7KQYCOggQLDp8QAUETBEgWEzZSTEQ0EGAYNHhAyogYIoAwWLKToqBgA4CBIsOH1ABAVMECBZTdlIMBHQQIFh0+IAKCJgiQLCYspNiIKCDAMGiwwdUQMAUAYLFlJ0UAwEdBAgWHT6gAgKmCBAspuykGAjoIECw6PABFRAwRYBgMWUnxUBABwGCRYcPqICAKQJJg2Vtbc0NDQ0VAMs30pbPueetqXlFMfecQLJgKfcUev78uXv16pWbm5urtwIhWO75TKR8UwSSBYusVvr7+4sw6erqutIN8a4FS09Pj3v9+rX7+vWrOz8\/Vz0p0FqNPXBtzjVpsHR3d7vJyUnX2Ei+fCrkW6xWMxXijSqTamlpyd0FvWiN53t5pLvIdWZmxp2cnFQDpDSqmmDxJsnKhQcEIBCfgASK7zQaf\/S\/R0waLDedCoksCRf54AEBCMQnIKfsqU7bkwVLq83b+BgZEQIQyEUgWbBIgf5y858\/f9zm5qbb29vLVTfHhQAEKiSQNFgqrIOhIQABRQTUBMtNb57LyWt2dtaNj48XEmq1mltYWLgip\/ycnKuxEK1e\/HVX5lJyDtW6s7PjBgYGCmmNb6rUptcz7ezsdDnnQTMuom95ednt7u5WfragIli07r+UjRCzJiYm3MrKijs6Oqp712iWBOTg4GBxKbr8vKp\/CUK0ljX4X9gcv6yhWoWlf4uCzJGRkRG3uLhYf1Nl1UzLIex\/IZvNA\/m6MJWHvKWi\/L6ts7OzVFKbHkf4yaVmeaTYhlARLK3ePJfLFXlVHR4eLkLi8vLSra+vu4ODA7exsXGjgdcFUNU13EarPPfly5euo6OjZT1V6A7R2tfX51ZXV93+\/n7lr66tagzRK2OUg7D8\/1bjV\/19CfLp6Wl3eHjoxsbG3Pb2duVM1QTLTW+eqxp8s\/FlQvk\/PZDnSLCcnp5eezrkx8g1oUK1yiSbn5937969c2\/evMkWLK24+mARrk+ePMl6KhTK1oeL\/D1cs9PmXHNZjiurlqmpKYLlppVBCoNuM6FET\/n5qZe\/oVpluX58fOy+fPkStAKrgnOIVr9fIVplX6u8akh5itnoa7MXGAnC8guPtlOhexssrd48V8UEbzVm6BK4cRncatwqvh+itby5WNaQep8lRKv\/RfWnnilfbRv9CdHbuNeWU2+z+ZVSk4pTobu8eetDRf697opRFSFy3ZihG6L+Zxt\/cVPplOOEai2fVuZcsYTobVyx5NRLsJQIaH3zXPmyaPmVXfTKQ\/7+QnbbZSPUP37\/\/p38qpBfsvtL49dpLQdfzmAJ1eo19vb2Zr9822oeCFvtl5vv3Yol5aslx4IABKonoOJUqPoyOQIEIJCSAMGSkjbHgsA9IUCw3BOjKRMCKQkQLClpcywI3BMCBMs9MZoyIZCSwP8BG5fHwmM5X4MAAAAASUVORK5CYII=","height":167,"width":278}}
%---
%[output:18865ac5]
%   data: {"dataType":"warning","outputData":{"text":"Warning: Length of lower bounds is < length(x); filling in missing lower bounds with -Inf for continuous and integer variables."}}
%---
%[output:13716439]
%   data: {"dataType":"warning","outputData":{"text":"Warning: Length of upper bounds is < length(x); filling in missing upper bounds with +Inf for continuous and integer variables."}}
%---
%[output:5d79b710]
%   data: {"dataType":"warning","outputData":{"text":"Warning: Initial point is not feasible. Initializing x0 at nearest feasible point."}}
%---
%[output:7fe7d649]
%   data: {"dataType":"error","outputData":{"errorType":"runtime","text":"Error using <a href=\"matlab:matlab.lang.internal.introspective.errorDocCallback('plot')\" style=\"font-weight:bold\">plot<\/a>\nInvalid data argument.\n\nError in <a href=\"matlab:matlab.lang.internal.introspective.errorDocCallback('LSQ_motor_model>AK10lsqPos\/tracklsq', 'C:\\Users\\gfben\\OneDrive\\Documents\\MSc\\Baleka-motor-ID\\LSQ\\LSQ_motor_model.m', 86)\" style=\"font-weight:bold\">LSQ_motor_model>AK10lsqPos\/tracklsq<\/a> (<a href=\"matlab: opentoline('C:\\Users\\gfben\\OneDrive\\Documents\\MSc\\Baleka-motor-ID\\LSQ\\LSQ_motor_model.m',86,0)\">line 86<\/a>)\n          plot(stepsq, 'r', 'DisplayName', 'Reference Step')\n          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nError in <a href=\"matlab:matlab.lang.internal.introspective.errorDocCallback('lsqnonlin', 'C:\\Program Files\\MATLAB\\R2025a\\toolbox\\shared\\optimlib\\lsqnonlin.m', 221)\" style=\"font-weight:bold\">lsqnonlin<\/a> (<a href=\"matlab: opentoline('C:\\Program Files\\MATLAB\\R2025a\\toolbox\\shared\\optimlib\\lsqnonlin.m',221,0)\">line 221<\/a>)\n            initVals.F = feval(funfcn{3},xCurrent,varargin{:});\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nError in <a href=\"matlab:matlab.lang.internal.introspective.errorDocCallback('LSQ_motor_model>AK10lsqPos', 'C:\\Users\\gfben\\OneDrive\\Documents\\MSc\\Baleka-motor-ID\\LSQ\\LSQ_motor_model.m', 78)\" style=\"font-weight:bold\">LSQ_motor_model>AK10lsqPos<\/a> (<a href=\"matlab: opentoline('C:\\Users\\gfben\\OneDrive\\Documents\\MSc\\Baleka-motor-ID\\LSQ\\LSQ_motor_model.m',78,0)\">line 78<\/a>)\npid = lsqnonlin(@tracklsq,pid0,[1.0, 0.5, 0.01],[1.7, 1, 0.5], options);\n^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nCaused by:\n    Failure in initial objective function evaluation. LSQNONLIN cannot continue."}}
%---
